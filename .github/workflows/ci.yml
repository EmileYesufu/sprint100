name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  lint-and-unit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install server dependencies
        run: npm install --prefix server

      - name: Install client dependencies
        run: npm install --prefix client

      - name: Lint
        run: npm run lint

      - name: Unit tests (server & client)
        run: npm run test:unit

      - name: Upload server unit coverage
        uses: actions/upload-artifact@v4
        with:
          name: server-unit-coverage
          path: server/coverage

      - name: Upload client unit coverage
        uses: actions/upload-artifact@v4
        with:
          name: client-unit-coverage
          path: client/coverage

  integration:
    needs: lint-and-unit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install server dependencies
        run: npm install --prefix server

      - name: Install client dependencies
        run: npm install --prefix client

      - name: Run integration suite
        run: npm run test:integration

      - name: Upload integration coverage
        uses: actions/upload-artifact@v4
        with:
          name: integration-coverage
          path: server/coverage

  build-mobile:
    needs: lint-and-unit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install client dependencies
        run: npm install --prefix client

      - name: Export Expo web bundle
        run: npx --prefix client expo export --platform web --output-dir client-web-build

      - name: Upload mobile build artifact
        uses: actions/upload-artifact@v4
        with:
          name: expo-web-build
          path: client-web-build

  release-checklist:
    needs:
      - lint-and-unit
      - integration
      - build-mobile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify MVP checklist
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const content = fs.readFileSync('docs/mvp-checklist.md', 'utf8').split('\n');
          const pending = content.filter((line) => /- \[ \]\s+\S+/.test(line));
          if (pending.length) {
            console.error('MVP checklist has unchecked items:\n' + pending.join('\n'));
            process.exit(1);
          }
          console.log('All MVP checklist items complete.');
          NODE
