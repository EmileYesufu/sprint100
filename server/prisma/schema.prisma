generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  username  String   @unique
  password  String
  elo       Int      @default(1200)
  createdAt DateTime @default(now())
  players   MatchPlayer[]
  queueEntries MatchQueue[]
  challengesSent Challenge[]     @relation("ChallengesSent")
  challengesReceived Challenge[] @relation("ChallengesReceived")
  resetTokens PasswordResetToken[]
  
  // Add computed fields for leaderboard
  matchesPlayed Int @default(0)
  wins          Int @default(0)
}

model Match {
  id        Int           @id @default(autoincrement())
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  status    MatchStatus   @default(QUEUED)
  duration  Int?
  players   MatchPlayer[]
  queueEntries MatchQueue[]
  challenges Challenge[]
}

model MatchPlayer {
  id            Int   @id @default(autoincrement())
  match         Match @relation(fields: [matchId], references: [id])
  matchId       Int
  user          User  @relation(fields: [userId], references: [id])
  userId        Int
  finishPosition Int?
  timeMs        Int?
  deltaElo      Int?
  socketId      String?

  @@unique([matchId, userId], name: "matchId_userId")
}

model MatchQueue {
  id        Int          @id @default(autoincrement())
  userId    Int          @unique
  status    QueueStatus  @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  matchId   Int?
  user      User         @relation(fields: [userId], references: [id])
  match     Match?       @relation(fields: [matchId], references: [id])
}

model Challenge {
  id           Int              @id @default(autoincrement())
  challengerId Int
  opponentId   Int
  status       ChallengeStatus  @default(PENDING)
  matchId      Int?
  createdAt    DateTime         @default(now())
  challenger   User             @relation("ChallengesSent", fields: [challengerId], references: [id])
  opponent     User             @relation("ChallengesReceived", fields: [opponentId], references: [id])
  match        Match?           @relation(fields: [matchId], references: [id])

  @@unique([challengerId, opponentId, status], name: "unique_active_challenge")
}

model PasswordResetToken {
  id         Int      @id @default(autoincrement())
  userId     Int
  tokenHash  String   @unique
  expiresAt  DateTime
  consumed   Boolean  @default(false)
  consumedAt DateTime?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId, consumed, expiresAt])
}

enum QueueStatus {
  PENDING
  MATCHED
  CANCELLED
}

enum ChallengeStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum MatchStatus {
  QUEUED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
